# {{name}} Microservice (Gufo gRPC Service)

This repository contains the `{{name}}` microservice generated by **Gufo gRPC Microservice Creator**.
It is a production-ready template that sits **behind Gufo API Gateway** and communicates via gRPC
using the `Reverse` service.

The service already includes:

- gRPC server with **unary & streaming** handlers
- Unified **middleware chain** (request ID, logging, security, metrics, recovery)
- **Heartbeat** sender to `masterservice` (for service registry & uptime)
- **Health/info** handlers for basic diagnostics
- **File upload / streaming** support compatible with `GRPCStreamPut` in Gufo
- Cron runner & entrypoint hooks
- Graceful shutdown with timeout
- Optional Redis pool (shared from Gufo DAO)

---

## 1. Architecture Overview

### 1.1 Request flow

```text
Client (HTTP/REST)
        |
        v
Gufo API Gateway (HTTP → gRPC)
        |
        v
gRPC (Reverse.Do / Reverse.Stream)
        |
        v
test microservice
  - router (Init + routerLookup)
  - business logic handlers
  - streaming/file upload handler
````

### 1.2 Config loading

```text
./config/config.(toml|yaml|json)
        |
        v
Viper
        |
        v
- security.mode (sign/hmac/mtls)
- server.grpc_timeout
- microservices.test.* (port, entrypointversion, cron)
- sentry.*, redis.*, etc.
```

### 1.3 Middleware chain

```text
Incoming gRPC call
        |
        v
RequestID  →  Logging  →  Security  →  Metrics  →  Recovery  →  Handler(Do/Stream)
```

* **RequestID** – injects a request ID into context/ logs
* **Logging** – structured logs for each call
* **Security** – validates HMAC / sign / mTLS metadata
* **Metrics** – increments Prometheus-style counters & durations
* **Recovery** – catches panics so the process does NOT crash

---

## 2. Requirements

* Go `1.21+` (recommended)
* Gufo API Gateway & masterservice running in the same network
* Docker (optional, for containerized run)
* `make` (optional, if you use the Makefile pattern)
* Valid `config/config.toml` (or `.yaml`/`.json`) for this service

---

## 3. Quick Start

### 3.1 Run without Docker

```bash
go mod tidy
go run ./...
```

By default the service looks for:

```text
./config/config.toml
```

You must configure at least:

* `security.mode` and required keys
* `microservices.test.port`
* `server.sign` (for `sign` mode) or `security.hmac_secret` (for `hmac`)

### 3.2 Run with Docker

Build:

```bash
docker build -t test:latest -f Dockerfile .
# or
docker build --no-cache -t test:latest -f Dockerfile .
```

Run (same network as Gufo API Gateway):

```bash
docker run --name test \
  --restart=always \
  -v $(pwd)/config:/var/gufo/config \
  -v $(pwd)/lang:/var/gufo/lang \
  -v $(pwd)/templates:/var/gufo/templates \
  -v $(pwd)/logs:/var/gufo/log \
  -v $(pwd)/files:/var/gufo/files \
  --network="gufo" \
  -d test:latest
```

Adjust volume paths and network name according to your environment.

### 3.3 Example Makefile (optional)

If you use the standard Makefile pattern:

```bash
make build   # go build ./...
make run     # go run ./...
make docker  # docker build ...
```

---

## 4. Gufo Integration

### 4.1 API Gateway config

In Gufo API Gateway config (e.g. `config.toml`) add:

```toml
[microservices]

[microservices.test]
type              = "server"
host              = "test"     # Docker container name OR hostname
port              = "5300"
entrypointversion = "1.0.0"
cron              = false
```

* `host` must match the Docker container or host name reachable from the Gateway.
* `port` must match `microservices.test.port` from this microservice's config.

### 4.2 Masterservice & heartbeat

The microservice sends periodic **heartbeat** to `masterservice` through Gufo’s internal
`GRPCReq` helper. Heartbeat payload includes:

* `name` – microservice name (`test`)
* `host`, `port`
* `group` (if used)
* `isinternal`, `issession`
* `description`, `author`, `version`

Masterservice uses this to track availability and echo timestamp.

---

## 5. Configuration Details

Example `config.toml` snippet for this microservice:

```toml
[server]
sentry           = false
grpc_timeout     = "30s"
stream_timeout   = "10m"
shutdown_timeout = "10s"
checktoken       = false

[security]
mode          = "sign"          # "sign" | "hmac" | "mtls"
hmac_secret   = ""              # required when mode = "hmac"
max_age       = 60              # seconds, for HMAC
# For sign mode
# server.sign must be set in [server]
# For mTLS:
# tls.cert, tls.key, tls.ca must be set

[microservices.test]
port              = "5300"
entrypointversion = "1.0.0"
cron              = false
group             = ""
isinternal        = false
issession         = false
description       = "Example generated microservice"
author            = "Your Name"
```

If you use Redis from Gufo DAO:

```toml
[redis]
host         = "redis:6379"
password     = ""
tls          = false
max_idle     = 5
max_active   = 20
idle_timeout = 240
```

---

## 6. API Overview

All external HTTP traffic passes through **Gufo API Gateway**, which converts it to gRPC
calls:

* `Reverse.Do` – for normal requests
* `Reverse.Stream` – for streaming/file uploads

### 6.1 Basic endpoints (via Gateway)

Assuming default API prefix `/api/v3` and service name `test`:

#### Info

```http
GET /api/v3/test/info
```

* Returns microservice info: `pluginname`, `version`, `description`.

#### Health

```http
GET /api/v3/test/health
```

* Returns `{"health":"OK"}` as a simple health status.

#### Heartbeat (local, used by masterservice/Gateway)

```http
GET /api/v3/test/heartbeat
```

* Returns `{"status":"alive"}` directly from the microservice.

> Business logic routes are defined in `router.go` / `Init` function.
> Add your own `METHOD:param` mappings there.

---

## 7. Streaming & File Upload (Reverse.Stream)

The microservice implements `Reverse.Stream` fully compatible with
Gufo `GRPCStreamPut`:

* **meta** messages: `start` / `end` (stored in `Args["meta"]` as `pb.StringMap`)
* **chunk** messages: file bytes (stored in `Args["chunk"]` as `pb.FileChunk`)

### 7.1 Protocol

1. **Start file**

   ```json
   {
     "Args": {
       "meta": {
         "filename": "example.bin",
         "phase": "start"
       }
     }
   }
   ```

2. **Send chunks**

   ```json
   {
     "Args": {
       "chunk": {
         "name": "example.bin",
         "data": "<binary>"
       }
     }
   }
   ```

3. **Finish file**

   ```json
   {
     "Args": {
       "meta": {
         "filename": "example.bin",
         "phase": "end"
       }
     }
   }
   ```

The service:

* writes files into `/tmp/<module>/filename`
* calls `processUploadedFile(path)` asynchronously after `phase = "end"`

### 7.2 How to enable streaming

Streaming is enabled by default in this service. To use it:

* Use Gufo API Gateway’s `GRPCStreamPut` (or your own streaming client).
* Make sure `server.stream_timeout` and `server.stream_max_file_size`
  (if used) are configured appropriately.
* Implement `processUploadedFile(path string)` in your microservice
  (e.g. parse, store or forward file).

---

## 8. Extending Business Logic

### 8.1 Add a new route

1. Define handler in `router.go`:

   ```go
   func myHandler(ctx context.Context, t *pb.Request) *pb.Response {
       // Your business logic here
       ans := map[string]interface{}{
           "status": "ok",
       }
       return Interfacetoresponse(t, ans)
   }
   ```

2. Register route in `routeTable`:

   ```go
   var routeTable = map[string]handlerFunc{
       "GET:info":    infoHandler,
       "GET:health":  healthHandler,
       "POST:admin":  adminHandler,
       "POST:my-api": myHandler,
   }
   ```

3. Call via Gateway:

   ```http
   POST /api/v3/test/my-api
   ```

### 8.2 Where to put heavy logic

Keep handlers thin:

* Params/validation → handler
* Heavy logic / domain rules → separate internal packages
* IO (DB, external services) → dedicated internal modules

---

## 9. FAQ

**Q: Where is authentication/authorization done?**
A: Low-level security (sign/hmac/mtls) is checked in middleware and `verifyRequestSecurity`.
High-level auth (roles, ACL) should be implemented in your handlers or dedicated services
(e.g. `auth`, `rights` microservices).

**Q: How does the service know its port?**
A: From `microservices.<name>.port` in config. API Gateway must use the same `host` and `port`
in its own configuration.

**Q: How do I disable heartbeat?**
A: Remove or comment out `go StartHeartbeat()` in `main.go`, or change the heartbeat
interval in config so that masterservice treats this service as “passive”.

**Q: How do I change logging format?**
A: Update `SetLog` / `SetErrorLog` implementations in Gufo DAO or adapt `middleware/logging.go`.

**Q: Is Redis mandatory?**
A: No. Redis is optional. It is only used when you explicitly use `CachePool` or other
Redis-based features.

---

## 10. License

This microservice is part of the Gufo ecosystem and is provided under the Apache 2.0 license
(unless you changed it in your project).

