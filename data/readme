# {{name}} Microservice (Gufo gRPC Service)

This repository contains the `{{name}}` microservice generated by **Gufo gRPC Microservice Creator**.
It is a production-ready template that sits **behind Gufo API Gateway** and communicates via gRPC
using the `Reverse` service.

The service already includes:

- gRPC server with **unary & streaming** handlers
- Unified **middleware chain** (request ID, logging, security, metrics, recovery)
- **Heartbeat** sender to `masterservice` (for service registry & uptime)
- **Health/info** handlers for basic diagnostics
- **File upload / streaming** support compatible with `GRPCStreamPut` in Gufo
- Cron runner & entrypoint hooks
- Graceful shutdown with timeout
- Optional Redis pool (shared from Gufo DAO)

---

## 1. Architecture Overview

### 1.1 Request flow

```text
Client (HTTP/REST)
        |
        v
Gufo API Gateway (HTTP → gRPC)
        |
        v
gRPC (Reverse.Do / Reverse.Stream)
        |
        v
{{name}} microservice
  - router (Init + routerLookup)
  - business logic handlers
  - streaming/file upload handler
````

### 1.2 Config loading

```text
./config/config.(toml|yaml|json)
        |
        v
Viper
        |
        v
- security.mode (sign/hmac/mtls)
- server.grpc_timeout
- microservices.{{name}}.* (port, entrypointversion, cron)
- sentry.*, redis.*, etc.
```

### 1.3 Middleware chain

```text
Incoming gRPC call
        |
        v
RequestID  →  Logging  →  Security  →  Metrics  →  Recovery  →  Handler(Do/Stream)
```

* **RequestID** – injects a request ID into context/ logs
* **Logging** – structured logs for each call
* **Security** – validates HMAC / sign / mTLS metadata
* **Metrics** – increments Prometheus-style counters & durations
* **Recovery** – catches panics so the process does NOT crash

---

## 2. Requirements

* Go `1.21+` (recommended)
* Gufo API Gateway v1.22+ &/or masterservice running in the same network
* Docker (optional, for containerized run)
* `make` (optional, if you use the Makefile pattern)
* Valid `config/config.toml` (or `.yaml`/`.json`) for this service

---

## 3. Quick Start

### 3.1 Run without Docker

```bash
go mod tidy
go run ./...
```

By default the service looks for:

```text
./config/config.toml
```

You must configure at least:

* `security.mode` and required keys
* `microservices.{{name}}.port`
* `server.sign` (for `sign` mode) or `security.hmac_secret` (for `hmac`)

### 3.2 Run with Docker

Build:

```bash
docker build -t {{name}}:latest -f Dockerfile .
# or
docker build --no-cache -t {{name}}:latest -f Dockerfile .
```

Run (same network as Gufo API Gateway):

```bash
docker run --name {{name}} \
  --restart=always \
  -v $(pwd)/config:/var/gufo/config \
  -v $(pwd)/lang:/var/gufo/lang \
  -v $(pwd)/templates:/var/gufo/templates \
  -v $(pwd)/logs:/var/gufo/log \
  -v $(pwd)/files:/var/gufo/files \
  --network="gufo" \
  -d {{name}}:latest
```

Adjust volume paths and network name according to your environment.

### 3.3 Example Makefile (optional)

If you use the standard Makefile pattern:

```bash
make build   # go build ./...
make run     # go run ./...
make docker  # docker build ...
```

---

## 4. Gufo Integration

### 4.1 API Gateway config

In Gufo API Gateway config (e.g. `config.toml`) add:

```toml
[microservices]

[microservices.{{name}}]
type              = "server"
host              = "{{name}}"     # Docker container name OR hostname
port              = "5300"
entrypointversion = "1.0.0"
cron              = false
```

* `host` must match the Docker container or host name reachable from the Gateway.
* `port` must match `microservices.{{name}}.port` from this microservice's config.

### 4.2 Masterservice & heartbeat

The microservice sends periodic **heartbeat** to `masterservice` through Gufo’s internal
`GRPCReq` helper. Heartbeat payload includes:

* `name` – microservice name (`{{name}}`)
* `host`, `port`
* `group` (if used)
* `isinternal`, `issession`
* `description`, `author`, `version`

Masterservice uses this to track availability and echo timestamp.

---

## 5. Configuration Details

Example `config.toml` snippet for this microservice:

```toml
[server]
sentry           = false
grpc_timeout     = "30s"
stream_timeout   = "10m"
shutdown_timeout = "10s"
checktoken       = false

[security]
mode          = "sign"          # "sign" | "hmac" | "mtls"
hmac_secret   = ""              # required when mode = "hmac"
max_age       = 60              # seconds, for HMAC
# For sign mode
# server.sign must be set in [server]
# For mTLS:
# tls.cert, tls.key, tls.ca must be set

[microservices.{{name}}]
port              = "5300"
entrypointversion = "1.0.0"
cron              = false
group             = ""
isinternal        = false
issession         = false
description       = "Example generated microservice"
author            = "Your Name"
```

If you use Redis from Gufo DAO:

```toml
[redis]
host         = "redis:6379"
password     = ""
tls          = false
max_idle     = 5
max_active   = 20
idle_timeout = 240
```

---

## 6. API Overview

All external HTTP traffic passes through **Gufo API Gateway**, which converts it to gRPC
calls:

* `Reverse.Do` – for normal requests
* `Reverse.Stream` – for streaming/file uploads

### 6.1 Basic endpoints (via Gateway)

Assuming default API prefix `/api/v3` and service name `{{name}}`:

#### Info

```http
GET /api/v3/{{name}}/info
```

* Returns microservice info: `pluginname`, `version`, `description`.

#### Health

```http
GET /api/v3/{{name}}/health
```

* Returns `{"health":"OK"}` as a simple health status.

#### Heartbeat (local, used by masterservice/Gateway)

```http
GET /api/v3/{{name}}/heartbeat
```

* Returns `{"status":"alive"}` directly from the microservice.

> Business logic routes are defined in `router.go` / `Init` function.
> Add your own `METHOD:param` mappings there.

---

## 7. Streaming & File Upload (Reverse.Stream)

The microservice implements `Reverse.Stream` fully compatible with
Gufo `GRPCStreamPut`:

* **meta** messages: `start` / `end` (stored in `Args["meta"]` as `pb.StringMap`)
* **chunk** messages: file bytes (stored in `Args["chunk"]` as `pb.FileChunk`)

### 7.1 Protocol

1. **Start file**

   ```json
   {
     "Args": {
       "meta": {
         "filename": "example.bin",
         "phase": "start"
       }
     }
   }
   ```

2. **Send chunks**

   ```json
   {
     "Args": {
       "chunk": {
         "name": "example.bin",
         "data": "<binary>"
       }
     }
   }
   ```

3. **Finish file**

   ```json
   {
     "Args": {
       "meta": {
         "filename": "example.bin",
         "phase": "end"
       }
     }
   }
   ```

The service:

* writes files into `/tmp/<module>/filename`
* calls `processUploadedFile(path)` asynchronously after `phase = "end"`

### 7.2 How to enable streaming

Streaming is enabled by default in this service. To use it:

* Use Gufo API Gateway’s `GRPCStreamPut` (or your own streaming client).
* Make sure `server.stream_timeout` and `server.stream_max_file_size`
  (if used) are configured appropriately.
* Implement `processUploadedFile(path string)` in your microservice
  (e.g. parse, store or forward file).

---

## 8. Extending Business Logic

### 8.1 Add a new route

1. Define handler in `router.go`:

   ```go
   func myHandler(ctx context.Context, t *pb.Request) *pb.Response {
       // Your business logic here
       ans := map[string]interface{}{
           "status": "ok",
       }
       return Interfacetoresponse(t, ans)
   }
   ```

2. Register route in `routeTable`:

   ```go
   var routeTable = map[string]handlerFunc{
       "GET:info":    infoHandler,
       "GET:health":  healthHandler,
       "POST:admin":  adminHandler,
       "POST:my-api": myHandler,
   }
   ```

3. Call via Gateway:

   ```http
   POST /api/v3/{{name}}/my-api
   ```

### 8.2 Where to put heavy logic

Keep handlers thin:

* Params/validation → handler
* Heavy logic / domain rules → separate internal packages
* IO (DB, external services) → dedicated internal modules

---

## 9. Cron Execution Model (Local + Heartbeat)

This microservice uses a **dual-control cron model**:

Cron is executed **ONLY when both of the following conditions are true**:

1. **Local cron is enabled** (via admin API or config)
2. **Gateway heartbeat allows cron execution** (cluster-level permission)

This prevents:

* duplicate cron execution in multi-replica deployments,
* uncontrolled cron execution in аварийных ситуациях.

### 9.1 Cron control flow

```text
Admin / Config        Gateway Heartbeat
        |                     |
        v                     v
   SetLocalCronState     ApplyCronState
             \           /
              \         /
               \       /
                reconcile()
                     |
                     v
                Cron Start / Stop
```

Cron loop:

* executed inside `cron.Init()`
* scheduled by ticker
* terminated via `stopChan` + `doneChan`
* protected by mutex

---

### 9.2 Enabling cron locally (admin/config)

Admin endpoint:

```http
POST /api/v3/{{name}}/admin/cron
```

Payload:

```json
{
  "action": "true"
}
```

This sets the **local cron flag**.
Cron will still NOT run unless heartbeat permission is also `true`.

---

### 11.3 Heartbeat permission (cluster)

Gateway sends cluster-level permission via heartbeat response:

```json
{
  "data": {
    "cron": true
  }
}
```

This value is passed into:

```go
cron.ApplyCronState(flag)
```

Cron runs **only if both local + heartbeat flags are true**.

---

### 9.4 Emergency cron stop

Cron can be stopped in **two independent ways**:

* Local admin disable (`action: false`)
* Heartbeat permission revoked by Gateway

Both immediately stop cron execution.

---

## 10. Admin API (Optional, Template-Controlled)

Admin API is **disabled by default** in production template.
It is enabled only if explicitly configured:

```toml
[microservices.{{name}}]
admin = true
```

### 10.1 Security Model

Admin access requires:

* valid Gufo security signature (sign/hmac/mTLS)
* `t.IsAdmin == 1` flag injected by Gufo middleware

Unauthorized admin requests return:

```http
401 You have no admin rights
```

---

### 10.2 Available admin routes

#### Check cron status

```http
GET /api/v3/{{name}}/admin/cronstatus
```

Returns:

```json
{
  "cronstatus": "true"
}
```

Reports **local cron flag (config/admin level)**.

---

#### Enable / Disable cron locally

```http
POST /api/v3/{{name}}/admin/cron
```

Payload:

```json
{
  "action": "true"
}
```

or

```json
{
  "action": "false"
}
```

This toggles **local cron state only**.
Actual execution still depends on Gateway heartbeat permission.

---

## 11. Testing

This microservice supports **both unit and integration testing**.

---

### 11.1 Unit tests

Unit tests validate:

* cron state logic
* utility functions
* non-networked business logic

Run:

```bash
make test
```

Equivalent:

```bash
go test ./... -v
```

---

### 11.2 Integration tests (gRPC)

Integration tests validate live behavior through real gRPC:

* service startup
* routing
* health
* info
* admin access
* error handling

They run against a real container instance.

Run:

```bash
make test-integration
```

This internally executes:

```bash
docker-compose up -d --build
go test ./tests -v
docker-compose down
```

---

### 11.3 Health test only

Used for CI smoke validation:

```bash
make test-health
```

Executes:

```bash
go test ./tests -run TestHealthGRPC -v
```

Validates:

* gRPC connectivity
* router
* Reverse.Do
* `GET:health` handler

---

## 12. Docker-Compose for testing

Example `docker-compose.yml` used for integration tests:

```yaml
version: "3.9"

services:
  {{name}}-ms:
    build: .
    container_name: {{name}}-ms
    ports:
      - "5300:5300"
    volumes:
      - ./config:/app/config
    environment:
      - GO_ENV=dev

      # Enable / disable admin API
      - MICROSERVICES_{{name_up}}_ADMIN=false

      # Enable / disable local cron
      - MICROSERVICES_{{name_up}}_CRON=false

      # Heartbeat interval in seconds
      - SERVER_HEARTBEAT=10
```

---

## 13. Makefile testing Targets

Available test targets:

```bash
make test               # unit tests
make test-integration   # full docker + gRPC tests
make test-health        # only health gRPC test
```

These targets are defined in the Makefile and are CI-ready.

---

## 14. CI/CD testing Recommendations

Recommended CI pipeline order:

```text
go mod tidy
make lint
make test
make test-health
```

Full integration tests (`make test-integration`) should be run:

* on staging
* before production releases
* after major protocol changes

---

## 15. Cron Safety Guarantees

This implementation guarantees:

* no duplicate cron execution in multi-replica clusters
* immediate shutdown on heartbeat revoke
* emergency manual stop via admin
* clean shutdown with `doneChan` handshake
* no runaway goroutines
* no race conditions

---

## 16. Template Usage Guidelines

Use this microservice template when:

* you need gRPC behind Gufo Gateway
* you need optional cron execution
* you need optional admin control
* you need production-safe startup/shutdown behavior
* you need CI-ready test infrastructure


---

## 17. FAQ

**Q: Where is authentication/authorization done?**
A: Low-level security (sign/hmac/mtls) is checked in middleware and `verifyRequestSecurity`.
High-level auth (roles, ACL) should be implemented in your handlers or dedicated services
(e.g. `auth`, `rights` microservices).

**Q: How does the service know its port?**
A: From `microservices.<name>.port` in config. API Gateway must use the same `host` and `port`
in its own configuration.

**Q: How do I disable heartbeat?**
A: Remove or comment out `go StartHeartbeat()` in `main.go`, or change the heartbeat
interval in config so that masterservice treats this service as “passive”.

**Q: How do I change logging format?**
A: Update `SetLog` / `SetErrorLog` implementations in Gufo DAO or adapt `middleware/logging.go`.

**Q: Is Redis mandatory?**
A: No. Redis is optional. It is only used when you explicitly use `CachePool` or other
Redis-based features.

---

## 18. License

This microservice is part of the Gufo ecosystem and is provided under the Apache 2.0 license
(unless you changed it in your project).

